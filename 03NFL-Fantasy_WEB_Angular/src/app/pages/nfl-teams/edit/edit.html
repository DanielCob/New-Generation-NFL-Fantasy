<mat-card class="form-card" *ngIf="!loading(); else loadingTpl">
  <h2><mat-icon>edit</mat-icon> Edit NFL Team</h2>

  <form [formGroup]="form" (ngSubmit)="save()">
    <!-- Información básica -->
    <div class="grid">
      <mat-form-field appearance="outline">
        <mat-label>Team name</mat-label>
        <input matInput formControlName="teamName" />
        <mat-icon matPrefix>flag</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>City</mat-label>
        <input matInput formControlName="city" />
        <mat-icon matPrefix>location_city</mat-icon>
      </mat-form-field>
    </div>

    <h3>Branding (optional)</h3>

    <!-- Sección de carga de imagen -->
    <div class="upload-section">
      <div class="upload-control">
        <input 
          type="file" 
          #fileInput 
          accept="image/jpeg,image/jpg,image/png"
          (change)="onFileSelected($event)"
          style="display: none"
        />
        
        <button 
          mat-raised-button 
          type="button" 
          color="accent"
          (click)="fileInput.click()"
          [disabled]="uploading() || uploadingThumb()"
        >
          <mat-icon>upload</mat-icon>
          Seleccionar Nueva Imagen
        </button>

        <button 
          mat-raised-button 
          type="button" 
          color="primary"
          (click)="uploadImage()"
          [disabled]="!selectedFile() || uploading() || uploadingThumb()"
          *ngIf="selectedFile()"
        >
          <mat-icon>cloud_upload</mat-icon>
          Subir y Generar Thumbnail
        </button>

        <button 
          mat-stroked-button 
          type="button"
          (click)="clearImage()"
          [disabled]="uploading() || uploadingThumb()"
          *ngIf="imagePreview() || thumbnailPreview()"
        >
          <mat-icon>clear</mat-icon>
          Limpiar
        </button>
      </div>

      <!-- Vista previa de archivo seleccionado -->
      <div class="file-info" *ngIf="selectedFile() && !uploading()">
        <mat-icon>info</mat-icon>
        <span>{{ selectedFile()!.name }} ({{ (selectedFile()!.size / 1024 / 1024).toFixed(2) }} MB)</span>
      </div>

      <!-- Estado de carga -->
      <div class="upload-status" *ngIf="uploading() || uploadingThumb()">
        <mat-spinner diameter="24"></mat-spinner>
        <span *ngIf="uploading()">Subiendo imagen principal...</span>
        <span *ngIf="uploadingThumb()">Generando y subiendo thumbnail...</span>
      </div>

      <!-- Preview de imágenes -->
      <div class="image-previews" *ngIf="imagePreview() || thumbnailPreview()">
        <div class="preview-box" *ngIf="imagePreview()">
          <p class="preview-label">Imagen Principal:</p>
          <img [src]="imagePreview()!" alt="Preview" />
        </div>
        <div class="preview-box" *ngIf="thumbnailPreview()">
          <p class="preview-label">Thumbnail (320x180):</p>
          <img [src]="thumbnailPreview()!" alt="Thumbnail" />
        </div>
      </div>
    </div>

    <!-- O ingresar URL manualmente -->
    <div class="manual-url-section">
      <p class="section-note">O modifica las URLs manualmente:</p>
      
      <mat-form-field appearance="outline" class="full">
        <mat-label>Team image URL</mat-label>
        <input matInput formControlName="teamImageUrl" (change)="onTeamImageUrlChanged()" (blur)="onTeamImageUrlChanged()" />
        <mat-icon matPrefix>image</mat-icon>
      </mat-form-field>

      <div class="grid">
        <mat-form-field appearance="outline">
          <mat-label>Width</mat-label>
          <input matInput formControlName="teamImageWidth" readonly />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Height</mat-label>
          <input matInput formControlName="teamImageHeight" readonly />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Bytes</mat-label>
          <input matInput formControlName="teamImageBytes" readonly />
        </mat-form-field>
      </div>

      <div class="meta" *ngIf="computingA()">
        <mat-spinner diameter="18"></mat-spinner>
        <span>Computing team image metadata…</span>
      </div>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Thumbnail URL</mat-label>
        <input matInput formControlName="thumbnailUrl" (change)="onThumbUrlChanged()" (blur)="onThumbUrlChanged()" />
        <mat-icon matPrefix>photo_size_select_small</mat-icon>
      </mat-form-field>

      <div class="grid">
        <mat-form-field appearance="outline">
          <mat-label>Width</mat-label>
          <input matInput formControlName="thumbnailWidth" readonly />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Height</mat-label>
          <input matInput formControlName="thumbnailHeight" readonly />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Bytes</mat-label>
          <input matInput formControlName="thumbnailBytes" readonly />
        </mat-form-field>
      </div>

      <div class="meta" *ngIf="computingB()">
        <mat-spinner diameter="18"></mat-spinner>
        <span>Computing thumbnail metadata…</span>
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="actions">
      <button mat-stroked-button type="button" (click)="router.navigate(['/nfl-teams'])">
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>
      <button 
        mat-raised-button 
        color="primary" 
        type="submit" 
        [disabled]="saving() || form.invalid || uploading() || uploadingThumb() || computingA() || computingB()"
      >
        <ng-container *ngIf="!saving(); else savingTpl">Save</ng-container>
      </button>
    </div>
  </form>

  <ng-template #savingTpl><mat-spinner diameter="18"></mat-spinner></ng-template>
</mat-card>

<ng-template #loadingTpl>
  <div class="loading"><mat-spinner></mat-spinner></div>
</ng-template>