<!--
  profile-header.html
  -----------------------------------------------------------------------------
  Cambios:
  - Se muestra avatar si p.ProfileImageUrl existe.
  - Si la imagen falla al cargar, se oculta para evitar ícono roto.
  - Prefill de URL ya se hace en el TS.
-->

<mat-card class="ph-card" *ngIf="!loading(); else loadingTpl">
  <mat-card-header>
    <img class="avatar"
         [src]="avatarUrl()"
         (error)="onAvatarError($event)"
         alt="User avatar">
    <mat-card-title>
      <mat-icon>account_circle</mat-icon>
      <span>Mi Perfil</span>
    </mat-card-title>
    <mat-card-subtitle>Gestiona tu información personal y preferencias de cuenta</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    @if (profile(); as p) {
      <div class="grid">
        <!-- AVATAR (solo si existe URL y no falló la carga) -->
        @if (p.ProfileImageUrl && showAvatar()) {
          <div class="row photo-row">
            <div class="label">Photo</div>
            <div class="value">
              <img
                class="avatar-img"
                [src]="p.ProfileImageUrl!"
                alt="Profile image"
                referrerpolicy="no-referrer"
                (error)="onAvatarError($event)"
              />
            </div>
          </div>
        }

        <!-- No editables -->
        <div class="row">
          <div class="label">User ID</div>
          <div class="value">{{ p.UserID }}</div>
        </div>
        <div class="row">
          <div class="label">Email</div>
          <div class="value">{{ p.Email }}</div>
        </div>
        <div class="row">
          <div class="label">Account Status</div>
          <div class="value">{{ p.AccountStatus }}</div>
        </div>
        <div class="row">
          <div class="label">Created</div>
          <div class="value">{{ p.CreatedAt | date:'medium' }}</div>
        </div>
        <div class="row">
          <div class="label">Updated</div>
          <div class="value">{{ p.UpdatedAt | date:'medium' }}</div>
        </div>

        <mat-divider class="my-16"></mat-divider>

        <!-- Vista normal -->
        @if (!editing()) {
          <div class="row">
            <div class="label">Name</div>
            <div class="value">{{ p.Name }}</div>
          </div>
          <div class="row">
            <div class="label">Alias</div>
            <div class="value">{{ p.Alias }}</div>
          </div>
          <div class="row">
            <div class="label">Language</div>
            <div class="value">{{ p.LanguageCode }}</div>
          </div>

          <div class="actions">
            <button mat-raised-button color="primary" (click)="editing.set(true)">
              <mat-icon>edit</mat-icon> Editar perfil
            </button>
          </div>
        } @else {
          <!-- Modo edición -->
          <form [formGroup]="form" (ngSubmit)="save()">
            <mat-form-field appearance="outline" class="full">
              <mat-label>Name</mat-label>
              <input matInput formControlName="name" />
              <mat-icon matPrefix>person</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full">
              <mat-label>Alias</mat-label>
              <input matInput formControlName="alias" />
              <mat-icon matPrefix>badge</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full">
              <mat-label>Language</mat-label>
              <mat-select formControlName="languageCode">
                @for (lang of languages; track lang.code) {
                  <mat-option [value]="lang.code">{{ lang.label }}</mat-option>
                }
              </mat-select>
              <mat-icon matPrefix>translate</mat-icon>
            </mat-form-field>

            <!-- URL de imagen -->
            <mat-form-field appearance="outline" class="full">
              <mat-label>Profile image URL (opcional)</mat-label>
              <input
                matInput
                formControlName="profileImageUrl"
                (change)="onProfileImageUrlChanged()"
                (blur)="onProfileImageUrlChanged()"
                placeholder="https://..."
              />
              <mat-icon matPrefix>image</mat-icon>
              <mat-hint>
                Si indicas una URL, se calcularán Width/Height/Bytes automáticamente
                (requeridos por la API).
              </mat-hint>
            </mat-form-field>

            <!-- Metadatos (solo lectura) -->
            <div class="row meta-row">
              <mat-form-field appearance="outline">
                <mat-label>Width (px)</mat-label>
                <input matInput formControlName="profileImageWidth" readonly />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Height (px)</mat-label>
                <input matInput formControlName="profileImageHeight" readonly />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Bytes</mat-label>
                <input matInput formControlName="profileImageBytes" readonly />
              </mat-form-field>
            </div>

            <!-- Spinner de metadatos -->
            <div class="actions" *ngIf="computingImageMeta()">
              <mat-spinner diameter="20"></mat-spinner>
              <span>Calculando metadatos de imagen…</span>
            </div>

            <div class="actions">
              <button mat-button type="button" (click)="cancelEdit()">Cancelar</button>
              <button
                mat-raised-button
                color="primary"
                type="submit"
                [disabled]="form.invalid || saving() || computingImageMeta()"
              >
                @if (saving()) {
                  <mat-spinner diameter="18"></mat-spinner>
                } @else {
                  Guardar
                }
              </button>
            </div>
          </form>
        }
      </div>
    }
  </mat-card-content>
</mat-card>

<ng-template #loadingTpl>
  <div class="ph-loading">
    <mat-spinner></mat-spinner>
  </div>
</ng-template>
