<mat-card class="ph-card" *ngIf="!loading(); else loadingTpl">
  <mat-card-header>
    <mat-card-title>
      <mat-icon>devices</mat-icon>
      <span>Sessions</span>
    </mat-card-title>
    <mat-card-subtitle>Active sessions for your account</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <!-- CHANGE: aÃ±adimos [trackBy]="trackBySession" en la tabla -->
    <table
      mat-table
      [dataSource]="sessions()"
      [trackBy]="trackBySession"
      class="mat-elevation-z1 full-width">

      <!-- SessionID -->
      <ng-container matColumnDef="SessionID">
        <th mat-header-cell *matHeaderCellDef> Session ID </th>
        <!-- CHANGE: removido [class.current] porque usamos .current-row en <tr> -->
        <td mat-cell *matCellDef="let s">
          <div class="id-cell">
            <span class="mono">{{ s.SessionID }}</span>
            @if (currentSessionId() === s.SessionID) {
              <span class="badge">
                <mat-icon inline>star</mat-icon> current
              </span>
            }
          </div>
        </td>
      </ng-container>

      <!-- CreatedAt -->
      <ng-container matColumnDef="CreatedAt">
        <th mat-header-cell *matHeaderCellDef> Created </th>
        <td mat-cell *matCellDef="let s">{{ s.CreatedAt | date:'medium' }}</td>
      </ng-container>

      <!-- LastActivityAt -->
      <ng-container matColumnDef="LastActivityAt">
        <th mat-header-cell *matHeaderCellDef> Last Activity </th>
        <td mat-cell *matCellDef="let s">{{ s.LastActivityAt | date:'medium' }}</td>
      </ng-container>

      <!-- ExpiresAt -->
      <ng-container matColumnDef="ExpiresAt">
        <th mat-header-cell *matHeaderCellDef> Expires </th>
        <td mat-cell *matCellDef="let s">{{ s.ExpiresAt | date:'medium' }}</td>
      </ng-container>

      <!-- IsValid -->
      <ng-container matColumnDef="IsValid">
        <th mat-header-cell *matHeaderCellDef> Valid </th>
        <td mat-cell *matCellDef="let s">
          <mat-icon [ngClass]="s.IsValid ? 'ok' : 'bad'">
            {{ s.IsValid ? 'check_circle' : 'cancel' }}
          </mat-icon>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

      <!-- CHANGE: quitamos 'trackBy: trackBySession' de la microsintaxis -->
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        [class.current-row]="currentSessionId() === row.SessionID">
      </tr>
    </table>

    @if (sessions().length === 0) {
      <div class="empty">
        <mat-icon>info</mat-icon>
        <span>No active sessions found.</span>
      </div>
    }
  </mat-card-content>

  <mat-card-actions align="end">
    <button
      mat-flat-button
      color="warn"
      (click)="closeAll()"
      [disabled]="loadingAction() || sessions().length === 0">
      <mat-icon>logout</mat-icon>
      Cerrar todas
      @if (loadingAction()) {
        <mat-spinner diameter="18"></mat-spinner>
      }
    </button>
  </mat-card-actions>
</mat-card>

<ng-template #loadingTpl>
  <div class="ph-loading"><mat-spinner></mat-spinner></div>
</ng-template>